# Task Log: TASK-DB-20250408-221500 - Prioritize Coordinates Over City in Geolocation Queries

**Goal:** Analyze and modify the database utility functions in app/utils/db_utils.py to prioritize latitude and longitude coordinates over city names in geolocation queries. When the frontend provides latitude and longitude parameters, completely disregard any city parameter in the WHERE clause.

## Analysis

After examining the codebase, I found that the geolocation query logic is primarily implemented in the `_build_location_filters` method of the `JobQueryBuilder` class in `app/libs/job_matcher/query_builder.py`, not directly in `db_utils.py` as initially thought.

The current implementation adds both city and geo filters to the WHERE clauses when both are provided, which means that jobs must match both the city name AND be within the specified radius of the coordinates. This is not the desired behavior according to the task requirements.

### Current Implementation

The current implementation in `_build_location_filters` adds WHERE clauses for:
1. Country filter (if provided)
2. City filter (if provided)
3. Geo filter (if latitude and longitude are provided)

All of these filters are combined with AND logic, meaning a job must satisfy all provided filters to be included in the results.

### Required Changes

We need to modify the `_build_location_filters` method to:
1. Check if latitude and longitude are provided
2. If they are provided, ignore the city parameter completely
3. If they are not provided, use the city parameter as before
4. Keep the country filter unchanged

## Implementation Plan

1. Modify the `_build_location_filters` method in `app/libs/job_matcher/query_builder.py`
2. Add tests to verify the changes
3. Document the changes

## Implementation

### Changes to `_build_location_filters`

The method will be modified to prioritize latitude and longitude coordinates over city names. When both are provided, the city filter will be completely disregarded.

### Changes Made

I've modified the `_build_location_filters` method in `app/libs/job_matcher/query_builder.py` to:

1. Check if both latitude and longitude are provided using a new variable `has_geo_coordinates`
2. Only add the city filter if geo coordinates are NOT provided
3. Keep the country filter unchanged
4. Keep the geo filter logic unchanged

Here's the key part of the change:

```python
# Check if we have both latitude and longitude
has_geo_coordinates = location.latitude is not None and location.longitude is not None

# City filter - only add if geo coordinates are NOT provided
if location.city and not has_geo_coordinates:
    where_clauses.append("(l.city = %s OR l.city = 'remote')")
    query_params.append(location.city)
```

### Tests Added

I've added a new test case `test_geo_coordinates_prioritized_over_city` to `app/tests/test_geo_matching.py` that verifies:

1. When both geo coordinates and city are provided, the city filter is completely disregarded
2. The WHERE clauses only include the geo filter
3. The query parameters only include the geo parameters, not the city

### Verification

The changes have been implemented and tested. The modified code now prioritizes latitude and longitude coordinates over city names in geolocation queries. When the frontend provides latitude and longitude parameters, the city parameter is completely disregarded in the WHERE clause.

## Summary

The task has been completed successfully. The database utility functions have been modified to prioritize latitude and longitude coordinates over city names in geolocation queries. This change will improve the geolocation query strategy by ensuring that when precise coordinates are provided, they take precedence over potentially less accurate city name matching.

The implementation:
1. Preserves the existing functionality when only city or only coordinates are provided
2. Prioritizes coordinates over city names when both are provided
3. Maintains the country filter regardless of other parameters
4. Includes appropriate tests to verify the behavior

This change aligns with the larger task of updating the geolocation query strategy to make better use of precise coordinate data when available.